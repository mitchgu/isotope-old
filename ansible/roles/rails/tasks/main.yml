---
# Setup ruby
- include: setup.yml

# Install the app sources
- include: src.yml
  when: vm is not defined

# Install bundle
- include: bundle.yml

- name: Copy dotenv
  template:
    src: .env.j2
    dest: "{{ app_dir }}/.env"

# Update systemd target
- include: systemd.yml
  when: code_updated is defined and vm is not defined

# Do migrations manually in development
- name: Migrate db
  command: bundle exec rails db:migrate
  args:
    chdir: "{{ app_dir }}"
  when: code_updated is defined and vm is not defined

- name: Precompile assets
  command: bundle exec rails assets:precompile
  args:
    chdir: "{{ app_dir }}"
  when: code_updated is defined
